<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <title>Beachbot Control Hub</title>
    <style>
        #zone_joystick {
            width: 100vw;  /* 100% of viewport width */
            height: 50vh; /* 50% of viewport height */
            margin: 0 auto;
            background-color: #f0f0f0;
            position: relative;
        }
        #coordinates {
            text-align: center;
            font-size: 1.5em;
            margin-top: 20px;
        }
        /* Basic styling for the tabs */
        .tab {
            overflow: hidden;
            background-color: #f1f1f1;
        }
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 17px;
        }
        .tab button:hover {
            background-color: #ddd;
        }
        .tab button.active {
            background-color: #ccc;
        }
        .tabcontent {
            display: none;
            padding: 20px;
            border-top: none;
        }
        /* Show tab content when active */
        .tabcontent.active {
            display: block;
        }
    </style>
</head>
<body>
    <h2>Beachbot Control Hub</h2>
    <div class="tab">
        <button class="tablinks" onclick="openTab(event, 'rc_tab')">RC</button>
        <button class="tablinks" onclick="openTab(event, 'autonomous_tab')">Autonomous</button>
    </div>
    <div id="rc_tab" class="tabcontent">
        <h3>Navigate by remote control using a joystick below</h3>
        <div id="zone_joystick" style="float:left;width:100%;margin:0;padding:0;"></div>
        <!-- Display coordinates here -->
        <div id="coordinates">Turn (positive is right): 0, Drive (positive is forward): 0</div>

        <!-- Include NippleJS -->
        <script src="{{ url_for('static', filename='js/nipplejs.js') }}"></script>
        <script>
            // Initialize the joystick using NippleJS
            const joystickContainer = document.getElementById('zone_joystick');
            const coordinatesDisplay = document.getElementById('coordinates');

            const joystick = nipplejs.create({
                zone: joystickContainer,
                size: 200,
                color: 'blue',
            });
            // Listen for joystick move events and send data to Flask server
            joystick.on('move', (event, data) => {
                if (data && data.vector) {
                    const x = data.vector.x.toFixed(2);
                    const y = data.vector.y.toFixed(2);

                    // Update the coordinates display
                    coordinatesDisplay.textContent = `Turn (positive is right): ${x}, Drive (positive is forward): ${y}`;

                    // Send the joystick data to the server
                    fetch('/joystick_input', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ x: x, y: y, stop: false})
                    }).then(response => response.json())
                      .then(data => console.log(data));
                }
            });
            // Send zeros on joystick release
            joystick.on('end', () => {
                fetch('/joystick_input', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ x: 0.0, y: 0.0, stop: true})
                }).then(response => response.json())
                  .then(data => console.log("Joystick released:", data));

                // Update the coordinates display
                coordinatesDisplay.textContent = `Turn (positive is right): 0.00, Drive (positive is forward): 0.00`;

            });
        </script>
    </div>
    <div id="autonomous_tab" class="tabcontent">
        <h3>Navigate autonomously to your location</h3>
        <button onclick="sendNavigateRequest()">Navigate to me</button>
        <button onclick="cancelNavigateRequest()">Cancel</button>
        <div id="gps_coordinates">Status: IDLE</div>
        <script>
            const GPSCoordinatesDisplay = document.getElementById('gps_coordinates');
            function sendNavigateRequest() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            const latitude = position.coords.latitude;
                            const longitude = position.coords.longitude;

                            // Update the coordinates display
                            GPSCoordinatesDisplay.textContent = `Status: Navigating to Latitude: ${latitude}, Longitude: ${longitude}`;

                            // Send a navigate request with GPS data to the Flask server
                            fetch('/navigate', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    latitude: latitude,
                                    longitude: longitude,
                                }),
                            })
                            .then(response => response.json())
                            .then(data => {
                                console.log('Server response:', data);
                                GPSCoordinatesDisplay.textContent = `Status: Finished navigating to Latitude: ${latitude}, Longitude: ${longitude}`;
                            })
                            .catch(error => {
                                console.error('Error sending navigate request.');
                            });
                        },
                        function(error) {
                            console.error('Error getting GPS data:', error);
                        }
                    );
                } else {
                    alert("Geolocation is not supported by this browser.");
                }
            }
            function cancelNavigateRequest() {
                fetch('/navigate', {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Server response:', data);
                })
                .catch(error => {
                    console.error('Error sending cancel request:', error);
                });
                // Update the coordinates display
                GPSCoordinatesDisplay.textContent = `Status: IDLE`;
            }
        </script>
    </div>
    <script>
        // Function to open a tab and close others
        function openTab(event, tabName) {
            // Hide all tab content
            const tabcontent = document.querySelectorAll('.tabcontent');
            tabcontent.forEach((content) => content.classList.remove('active'));

            // Remove the "active" class from all tab buttons
            const tablinks = document.querySelectorAll('.tablinks');
            tablinks.forEach((tab) => tab.classList.remove('active'));

            // Show the current tab and add "active" class to the button
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');

            // Send a request to the server when switching tabs
            fetch(`/tab_switch`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ tab: tabName }),
            })
            .then(response => response.json())
            .then(data => {
                console.log(`Server response:`, data);
            })
            .catch(error => {
                console.error('Error sending tab switch request:', error);
            });
        }

        // Open Tab 1 by default
        document.addEventListener("DOMContentLoaded", function() {
            document.querySelector('.tablinks').click();
        });
    </script>
</body>
</html>
