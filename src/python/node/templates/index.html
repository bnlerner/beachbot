<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <title>Beachbot Control Hub</title>
    <style>
        #zone_joystick {
            width: 100vw;  /* 100% of viewport width */
            height: 50vh; /* 50% of viewport height */
            margin: 0 auto;
            background-color: #f0f0f0;
            position: relative;
        }
        #coordinates {
            text-align: center;
            font-size: 1.5em;
            margin-top: 20px;
        }
        /* Basic styling for the tabs */
        .tab-container {
            display: flex;
            justify-content: center;
            width: 100%;
            background-color: #f1f1f1;
            border-bottom: 2px solid #ccc;
        }
        .tab-button {
            flex: 1; /* Take up equal space */
            padding: 16px;
            text-align: center;
            cursor: pointer;
            font-size: 18px;
            color: white;
            background-color: #4CAF50;
            border: none;
            outline: none;
        }
        .tab-button.active {
            background-color: #3E8E41;
        }
        /* Tab content styles */
        .tab-content {
            display: none;
            padding: 20px;
        }
        /* Show tab content when active */
        .tab-content.active {
            display: block;
        }
        /* Action buton styles */
        .action-button {
            display: block;
            margin: 40px auto;
            padding: 20px 20px;
            font-weight: bold;
            text-align: center;
            font-size: 18px;
            color: blue;
            background-color: lightblue;
            border: 3px solid darkblue;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            width: 50%; /* Adjust width as needed */
            max-width: 150px; /* Maximum width for the button */
        }

        /* E-Stop button styles */
        .e-stop-button {
            display: block;
            margin: 40px auto;
            padding: 20px 20px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            background-color: #d9534f; /* Red color */
            border: 3px solid #c9302c; /* Darker red border */
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            width: 50%; /* Adjust width as needed */
            max-width: 150px; /* Maximum width for the button */
        }

        .e-stop-button:hover {
            background-color: #c9302c; /* Darker red on hover */
        }

    </style>
</head>
<body>
    <h2>Beachbot Control Hub</h2>
    <div class="tab-container">
        <button class="tab-button" onclick="openTab(event, 'rc_tab')">RC</button>
        <button class="tab-button" onclick="openTab(event, 'autonomous_tab')">Autonomous</button>
    </div>
    <div id="rc_tab" class="tab-content">
        <h3>Navigate by remote control using a joystick below</h3>
        <div id="zone_joystick" style="float:left;width:100%;margin:0;padding:0;"></div>
        <!-- Display coordinates here -->
        <div id="coordinates">Turn (positive is right): 0, Drive (positive is forward): 0</div>

        <!-- Include NippleJS -->
        <script src="{{ url_for('static', filename='js/nipplejs.js') }}"></script>
        <script>
            // Initialize the joystick using NippleJS
            const joystickContainer = document.getElementById('zone_joystick');
            const coordinatesDisplay = document.getElementById('coordinates');

            const joystick = nipplejs.create({
                zone: joystickContainer,
                size: 200,
                color: 'blue',
            });
            // Listen for joystick move events and send data to Flask server
            joystick.on('move', (event, data) => {
                if (data && data.vector) {
                    const x = data.vector.x.toFixed(2);
                    const y = data.vector.y.toFixed(2);

                    // Update the coordinates display
                    coordinatesDisplay.textContent = `Turn (positive is right): ${x}, Drive (positive is forward): ${y}`;

                    // Send the joystick data to the server
                    fetch('/joystick_input', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ x: x, y: y, stop: false})
                    }).then(response => response.json())
                      .then(data => console.log(data));
                }
            });
            // Send zeros on joystick release
            joystick.on('end', () => {
                fetch('/joystick_input', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ x: 0.0, y: 0.0, stop: true})
                }).then(response => response.json())
                  .then(data => console.log("Joystick released:", data));

                // Update the coordinates display
                coordinatesDisplay.textContent = `Turn (positive is right): 0.00, Drive (positive is forward): 0.00`;

            });
        </script>
    </div>
    <div id="autonomous_tab" class="tab-content">
        <h3>Navigate autonomously to your location</h3>
        <button class="action-button" onclick="sendNavigateRequest()">Navigate to me</button>
        <button class="action-button" onclick="cancelNavigateRequest()">Cancel</button>
        <div id="gps_coordinates">Status: Waiting Commands</div>
        <!-- E-Stop Button -->
        <button class="e-stop-button" onclick="sendEStop()">EMERGENCY STOP</button>

        <script>
            const GPSCoordinatesDisplay = document.getElementById('gps_coordinates');
            function sendNavigateRequest() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            const latitude = position.coords.latitude;
                            const longitude = position.coords.longitude;

                            // Update the coordinates display
                            GPSCoordinatesDisplay.textContent = `Status: Navigating to Latitude: ${latitude.toFixed(4)}, Longitude: ${longitude.toFixed(4)}`;

                            // Send a navigate request with GPS data to the Flask server
                            fetch('/navigate', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    latitude: latitude,
                                    longitude: longitude,
                                }),
                            })
                            .then(response => response.json())
                            .then(data => {
                                console.log('Server response:', data);
                                const message = data.message || '';
                                GPSCoordinatesDisplay.textContent = `Status: ${data.status}, message: ${message}`;
                            })
                            .catch(error => {
                                console.error('Error sending navigate request.');
                            });
                        },
                        function(error) {
                            console.error('Error getting GPS data:', error);
                        }
                    );
                } else {
                    alert("Geolocation is not supported by this browser.");
                }
            }
            function cancelNavigateRequest() {
                fetch('/navigate', {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Server response:', data);
                })
                .catch(error => {
                    console.error('Error sending cancel request:', error);
                });
                // Update the coordinates display
                GPSCoordinatesDisplay.textContent = `Status: Cancelling`;
            }
            function sendEStop() {
                fetch('/e-stop', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    GPSCoordinatesDisplay.textContent = `Status: ${data.status}`;
                    alert('Emergency Stop activated');
                    console.log('E-Stop response:', data);
                })
                .catch(error => {
                    console.error('Error activating E-Stop:', error);
                });
            }
        </script>
    </div>
    <script>
        // Function to open a tab and close others
        function openTab(event, tabName) {
            // Hide all tab content
            const tabcontent = document.querySelectorAll('.tab-content');
            tabcontent.forEach((content) => content.classList.remove('active'));

            // Remove the "active" class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(tab => tab.classList.remove('active'));

            // Show the current tab and add "active" class to the button
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');

            // Send a request to the server when switching tabs
            fetch(`/tab_switch`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ tab: tabName }),
            })
            .then(response => response.json())
            .then(data => {
                console.log(`Server response:`, data);
            })
            .catch(error => {
                console.error('Error sending tab switch request:', error);
            });
        }

        // Open Tab 1 by default
        document.addEventListener("DOMContentLoaded", function() {
            document.querySelector('.tab-button').click();
        });
    </script>
</body>
</html>
